<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å’–å•¡åˆ¸æŠ½ç</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
           margin: 0; background:#fafafa; color:#222; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06);
            padding:24px; text-align:center; }
    .avatar { width:96px; height:96px; border-radius:50%; object-fit:cover; display:block; margin: 0 auto 12px; }
    .title { font-size:20px; font-weight:700; margin: 6px 0 4px; }
    .sub { color:#666; font-size:14px; margin: 0 0 16px; }
    .btn { display:inline-block; padding:14px 18px; border-radius:12px; border:none; cursor:pointer;
           font-weight:700; font-size:16px; background:#06c755; color:#fff; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .note { font-size:12px; color:#888; margin-top:12px; }
    .result { font-size:22px; font-weight:800; margin:16px 0 6px; }
    .win { color:#06c755; } .lose { color:#c62828; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <img id="avatar" class="avatar" src="https://media.licdn.com/dms/image/v2/C5603AQFF25eere2iMQ/profile-displayphoto-shrink_200_200/profile-displayphoto-shrink_200_200/0/1516850218769?e=2147483647&v=beta&t=6n0i3Zbw2FhhxXFmYi8vRnEVdJ4U1HIiXLHEpr3ubqc" alt="avatar" />
      <div class="title">å’–å•¡åˆ¸æŠ½ç</div>
      <p class="sub">æŒ‰ä¸‹æŒ‰éˆ•å³é–‹å§‹æŠ½çï¼ŒçµæœæœƒåŒæ­¥å›å ±ä¸»è¾¦æ–¹ã€‚</p>

      <button id="drawBtn" class="btn">é–‹å§‹æŠ½ç</button>

      <div id="resultBox" class="hidden">
        <div id="resultText" class="result"></div>
        <div id="descText" class="sub"></div>
        <button id="againBtn" class="btn" style="background:#4c98ff;margin-top:12px;">å†æŠ½ä¸€æ¬¡ï¼ˆæ¸¬è©¦ç”¨ï¼‰</button>
      </div>

      <div class="note">è‹¥æœªç™»å…¥ LINEï¼Œç³»çµ±æœƒå¼•å°ä½ ç™»å…¥å¾Œå†å›ä¾†ã€‚</div>
    </div>
  </div>

  <script>
    // ---- åŸºæœ¬è¨­å®š ----
    const WEBHOOK = "https://wooow.zeabur.app/webhook/jakko";
    // å¯ç”¨ç¶²å€åƒæ•¸å¸¶ liffIdï¼Œä¾‹ï¼š?liffId=2000000000-xxxxxx
    const urlLiffId = new URL(location.href).searchParams.get('liffId') || '';
    const FALLBACK_AVATAR = document.getElementById('avatar').src;

    // ---- å…ƒä»¶ ----
    const drawBtn   = document.getElementById('drawBtn');
    const againBtn  = document.getElementById('againBtn');
    const resultBox = document.getElementById('resultBox');
    const resultText= document.getElementById('resultText');
    const descText  = document.getElementById('descText');
    const avatarImg = document.getElementById('avatar');

    // ---- ç‹€æ…‹ ----
    let liffReady   = false;
    let profile     = { userId: null, displayName: null, pictureUrl: null };
    let liffIdUsed  = null;

    // ---- åˆå§‹åŒ– LIFFï¼ˆå¯åœ¨ LIFF å…§æˆ–ä¸€èˆ¬ç€è¦½å™¨åŸ·è¡Œï¼‰----
    (async function init() {
      try {
        if (urlLiffId) {
          await liff.init({ liffId: urlLiffId });
          liffIdUsed = urlLiffId;
        } else {
          // è‹¥ä½ æƒ³ç¡¬å¯« LIFF IDï¼Œæ”¹é€™è£¡ï¼š
          // await liff.init({ liffId: "YOUR_LIFF_ID" });
          // liffIdUsed = "YOUR_LIFF_ID";
        }
        liffReady = true;

        if (liff.isInClient() || urlLiffId) {
          if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: location.href });
            return; // ç­‰è½‰è·³å›ä¾†
          }
          // å–å¾—ä½¿ç”¨è€…è³‡è¨Š
          const p = await liff.getProfile();
          profile.userId = p?.userId || null;
          profile.displayName = p?.displayName || null;
          profile.pictureUrl = p?.pictureUrl || null;
          if (profile.pictureUrl) avatarImg.src = profile.pictureUrl;
        }
      } catch (err) {
        console.warn("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œå°‡ä»¥ä¸€èˆ¬ç¶²é æ¨¡å¼é‹è¡Œï¼š", err);
      }
    })();

    // ---- æŠ½çä¸»ç¨‹å¼ï¼š50% ä¸­ç ----
    async function doDraw() {
      drawBtn.disabled = true;
      try {
        // 50% æ©Ÿç‡
        const isWin = Math.random() < 0.5;
        const outcome = isWin ? "WIN" : "LOSE";

        // UI é¡¯ç¤ºçµæœ
        resultText.textContent = isWin ? "ğŸ‰ æ­å–œä¸­çï¼" : "ğŸ˜­ å¾ˆå¯æƒœï¼Œæ²’ä¸­ç";
        resultText.className = "result " + (isWin ? "win" : "lose");
        descText.textContent = isWin
          ? "è«‹ä¾é é¢æˆ–è¨Šæ¯æŒ‡ç¤ºï¼Œå®Œæˆå¾ŒçºŒé ˜å–æ­¥é©Ÿã€‚"
          : "åˆ¥æ°£é¤’ï¼Œå†è©¦ä¸€æ¬¡ä¹Ÿè¨±å°±ä¸­å›‰ï¼";

        resultBox.classList.remove('hidden');

        // å›å ± webhook
        const payload = {
          type: "liff-lottery",
          liffId: liffIdUsed,
          outcome,
          ts: new Date().toISOString(),
          user: {
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl
          },
          ua: navigator.userAgent,
          context: (() => {
            try { return liff.getContext ? liff.getContext() : null; } catch { return null; }
          })(),
          nonce: (Math.random().toString(36).slice(2) + Date.now().toString(36))
        };

        await fetch(WEBHOOK, {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }).catch(err => {
          console.warn("Webhook å›å ±å¤±æ•—ï¼ˆå°‡ç•¥éï¼Œä¸å½±éŸ¿å‰ç«¯é«”é©—ï¼‰", err);
        });
      } finally {
        drawBtn.disabled = false;
      }
    }

    drawBtn.addEventListener('click', doDraw);
    againBtn.addEventListener('click', doDraw);
  </script>
</body>
</html>
