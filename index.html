<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å’–å•¡åˆ¸æŠ½ç</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
           margin: 0; background:#fafafa; color:#222; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06);
            padding:24px; text-align:center; }
    .cover { width:96px; height:96px; border-radius:50%; object-fit:cover; display:block; margin: 0 auto 12px; }
    .title { font-size:20px; font-weight:700; margin: 6px 0 4px; }
    .sub { color:#666; font-size:14px; margin: 0 0 16px; }

    .btn { display:inline-block; padding:14px 18px; border-radius:12px; border:none; cursor:pointer;
           font-weight:700; font-size:16px; background:#06c755; color:#fff; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .note { font-size:12px; color:#888; margin-top:12px; }
    .result { font-size:22px; font-weight:800; margin:16px 0 6px; }
    .win { color:#06c755; } .lose { color:#c62828; }
    .hidden { display:none; }

    /* æŠ½çå‹•ç•« */
    .spinner { width:44px; height:44px; margin: 12px auto;
      border:4px solid #e0e0e0; border-top-color:#06c755; border-radius:50%;
      animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- 1) å›ºå®šåœ–ç‰‡ï¼ˆå¯ç”¨ç¶²å€åƒæ•¸ ?img=URL è¦†è“‹ï¼‰ -->
      <img id="cover" class="cover"
           src="https://doqvf81n9htmm.cloudfront.net/data/crop_article/90406/shutterstock_323782706.jpg_1140x855.jpg"
           alt="cover" />
      <div class="title">å’–å•¡åˆ¸æŠ½ç</div>
      <p class="sub">æŒ‰ä¸‹æŒ‰éˆ•å³é–‹å§‹æŠ½çï¼ŒçµæœæœƒåŒæ­¥å›å ±ä¸»è¾¦æ–¹ã€‚</p>

      <button id="drawBtn" class="btn">é–‹å§‹æŠ½ç</button>

      <!-- æŠ½çä¸­å‹•ç•« -->
      <div id="drawingBox" class="hidden">
        <div class="spinner"></div>
        <div class="sub">æŠ½çä¸­ï¼Œç¨ç­‰å¹¾ç§’â€¦</div>
      </div>

      <!-- çµæœ -->
      <div id="resultBox" class="hidden">
        <div id="resultText" class="result"></div>
        <div id="descText" class="sub"></div>
      </div>

      <div class="note">è‹¥æœªç™»å…¥ LINEï¼Œç³»çµ±æœƒå¼•å°ä½ ç™»å…¥å¾Œå†å›ä¾†ã€‚</div>
    </div>
  </div>

  <script>
    // ---- è¨­å®š ----
    const WEBHOOK = "https://wooow.zeabur.app/webhook/jakko";
    // æ”¯æ´ç¶²å€åƒæ•¸
    const params = new URL(location.href).searchParams;
    const urlLiffId = params.get('liffId') || '';
    const IMG_URL   = params.get('img') ||
      "https://cdn-icons-png.flaticon.com/512/1046/1046784.png"; // é è¨­å’–å•¡åœ–ç¤º
    const LIFF_ID = "2008169900-g9qv0A8w"; // ä½ çš„ LIFF ID

    // ---- DOM ----
    const drawBtn    = document.getElementById('drawBtn');
    const drawingBox = document.getElementById('drawingBox');
    const resultBox  = document.getElementById('resultBox');
    const resultText = document.getElementById('resultText');
    const descText   = document.getElementById('descText');
    const coverImg   = document.getElementById('cover');

    // è¨­å®šå°é¢åœ–ï¼ˆä¸ä½¿ç”¨ä½¿ç”¨è€…é ­åƒï¼‰
    coverImg.src = IMG_URL;

    // ---- ç‹€æ…‹ ----
    let profile     = { userId: null, displayName: null, pictureUrl: null };
    let liffIdUsed  = null;

    // ---- åˆå§‹åŒ– LIFF ----
    (async function init() {
      try {
        const liffIdToUse = urlLiffId || LIFF_ID;
        if (liffIdToUse) {
          await liff.init({ liffId: liffIdToUse });
          liffIdUsed = liffIdToUse;
        }
        if (liff.isInClient() || liffIdToUse) {
          if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: location.href });
            return;
          }
          // å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼ˆåƒ…ç”¨æ–¼ webhook å›å ±ï¼Œä¸æ”¹å°é¢åœ–ï¼‰
          const p = await liff.getProfile();
          profile.userId = p?.userId || null;
          profile.displayName = p?.displayName || null;
          profile.pictureUrl = p?.pictureUrl || null;
        }
      } catch (err) {
        console.warn("LIFF åˆå§‹åŒ–å¤±æ•—ï¼ˆå°‡ä»¥ä¸€èˆ¬ç¶²é æ¨¡å¼é‹è¡Œï¼‰:", err);
      }
    })();

    // ---- æŠ½çä¸»ç¨‹å¼ï¼š50% ä¸­ç + å‹•ç•« 3~5 ç§’ + è‡ªå‹•é—œé–‰ ----
    async function doDraw() {
      // UIï¼šç¦ç”¨ä¸¦éš±è—æŒ‰éˆ• â†’ é¡¯ç¤ºå‹•ç•«
      drawBtn.disabled = true;
      drawBtn.classList.add('hidden');
      drawingBox.classList.remove('hidden');

      // éš¨æ©Ÿç­‰å¾… 3~5 ç§’
      const delay = 3000 + Math.floor(Math.random() * 2000);
      await new Promise(r => setTimeout(r, delay));

      // 50% æ©Ÿç‡
      const isWin = Math.random() < 0.5;
      const outcome = isWin ? "WIN" : "LOSE";

      // é¡¯ç¤ºçµæœ
      drawingBox.classList.add('hidden');
      resultText.textContent = isWin ? "ğŸ‰ æ­å–œä¸­çï¼" : "ğŸ˜­ å¾ˆå¯æƒœï¼Œæ²’ä¸­ç";
      resultText.className = "result " + (isWin ? "win" : "lose");
      descText.textContent = isWin
        ? "è«‹ä¾é é¢æˆ–è¨Šæ¯æŒ‡ç¤ºï¼Œå®Œæˆå¾ŒçºŒé ˜å–æ­¥é©Ÿã€‚"
        : "åˆ¥æ°£é¤’ï¼Œä¸‹æ¬¡å¥½é‹å°±æ˜¯ä½ ï¼";
      resultBox.classList.remove('hidden');

      // å›å ± webhook
      const payload = {
        type: "liff-lottery",
        liffId: liffIdUsed,
        outcome,
        ts: new Date().toISOString(),
        user: {
          userId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl
        },
        ua: navigator.userAgent,
        context: (() => {
          try { return liff.getContext ? liff.getContext() : null; } catch { return null; }
        })(),
        nonce: (Math.random().toString(36).slice(2) + Date.now().toString(36))
      };

      fetch(WEBHOOK, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).catch(err => console.warn("Webhook å›å ±å¤±æ•—ï¼ˆç•¥éï¼‰", err));

      // 3 ç§’å¾Œè‡ªå‹•é—œé–‰ LIFF è¦–çª—
      setTimeout(() => {
        try {
          if (typeof liff !== "undefined" && liff.isInClient()) {
            liff.closeWindow();
          } else {
            window.close();
          }
        } catch (_) {}
      }, 3000);
    }

    drawBtn.addEventListener('click', doDraw);
  </script>
</body>
</html>
