<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>咖啡券抽獎</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
           margin: 0; background:#fafafa; color:#222; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06);
            padding:24px; text-align:center; }
    .cover { width:96px; height:96px; border-radius:50%; object-fit:cover; display:block; margin: 0 auto 12px; }
    .title { font-size:20px; font-weight:700; margin: 6px 0 4px; }
    .sub { color:#666; font-size:14px; margin: 0 0 16px; }

    .btn { display:inline-block; padding:14px 18px; border-radius:12px; border:none; cursor:pointer;
           font-weight:700; font-size:16px; background:#06c755; color:#fff; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .note { font-size:12px; color:#888; margin-top:12px; }
    .result { font-size:22px; font-weight:800; margin:16px 0 6px; }
    .win { color:#06c755; } .lose { color:#c62828; }
    .hidden { display:none; }

    /* 抽獎動畫 */
    .spinner { width:44px; height:44px; margin: 12px auto;
      border:4px solid #e0e0e0; border-top-color:#06c755; border-radius:50%;
      animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- 1) 固定圖片（可用網址參數 ?img=URL 覆蓋） -->
      <img id="cover" class="cover"
           src="https://doqvf81n9htmm.cloudfront.net/data/crop_article/90406/shutterstock_323782706.jpg_1140x855.jpg"
           alt="cover" />
      <div class="title">咖啡券抽獎</div>
      <p class="sub">按下按鈕即開始抽獎，結果會同步回報主辦方。</p>

      <button id="drawBtn" class="btn">開始抽獎</button>

      <!-- 抽獎中動畫 -->
      <div id="drawingBox" class="hidden">
        <div class="spinner"></div>
        <div class="sub">抽獎中，稍等幾秒…</div>
      </div>

      <!-- 結果 -->
      <div id="resultBox" class="hidden">
        <div id="resultText" class="result"></div>
        <div id="descText" class="sub"></div>
      </div>

      <div class="note">若未登入 LINE，系統會引導你登入後再回來。</div>
    </div>
  </div>

  <script>
    // ---- 設定 ----
    const WEBHOOK = "https://wooow.zeabur.app/webhook/jakko";
    // 支援網址參數
    const params = new URL(location.href).searchParams;
    const urlLiffId = params.get('liffId') || '';
    const IMG_URL   = params.get('img') ||
      "https://cdn-icons-png.flaticon.com/512/1046/1046784.png"; // 預設咖啡圖示
    const LIFF_ID = "2008169900-g9qv0A8w"; // 你的 LIFF ID

    // ---- DOM ----
    const drawBtn    = document.getElementById('drawBtn');
    const drawingBox = document.getElementById('drawingBox');
    const resultBox  = document.getElementById('resultBox');
    const resultText = document.getElementById('resultText');
    const descText   = document.getElementById('descText');
    const coverImg   = document.getElementById('cover');

    // 設定封面圖（不使用使用者頭像）
    coverImg.src = IMG_URL;

    // ---- 狀態 ----
    let profile     = { userId: null, displayName: null, pictureUrl: null };
    let liffIdUsed  = null;

    // ---- 初始化 LIFF ----
    (async function init() {
      try {
        const liffIdToUse = urlLiffId || LIFF_ID;
        if (liffIdToUse) {
          await liff.init({ liffId: liffIdToUse });
          liffIdUsed = liffIdToUse;
        }
        if (liff.isInClient() || liffIdToUse) {
          if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: location.href });
            return;
          }
          // 取得使用者資訊（僅用於 webhook 回報，不改封面圖）
          const p = await liff.getProfile();
          profile.userId = p?.userId || null;
          profile.displayName = p?.displayName || null;
          profile.pictureUrl = p?.pictureUrl || null;
        }
      } catch (err) {
        console.warn("LIFF 初始化失敗（將以一般網頁模式運行）:", err);
      }
    })();

    // ---- 抽獎主程式：50% 中獎 + 動畫 3~5 秒 + 自動關閉 ----
    async function doDraw() {
      // UI：禁用並隱藏按鈕 → 顯示動畫
      drawBtn.disabled = true;
      drawBtn.classList.add('hidden');
      drawingBox.classList.remove('hidden');

      // 隨機等待 3~5 秒
      const delay = 3000 + Math.floor(Math.random() * 2000);
      await new Promise(r => setTimeout(r, delay));

      // 50% 機率
      const isWin = Math.random() < 0.5;
      const outcome = isWin ? "WIN" : "LOSE";

      // 顯示結果
      drawingBox.classList.add('hidden');
      resultText.textContent = isWin ? "🎉 恭喜中獎！" : "😭 很可惜，沒中獎";
      resultText.className = "result " + (isWin ? "win" : "lose");
      descText.textContent = isWin
        ? "請依頁面或訊息指示，完成後續領取步驟。"
        : "別氣餒，下次好運就是你！";
      resultBox.classList.remove('hidden');

      // 回報 webhook
      const payload = {
        type: "liff-lottery",
        liffId: liffIdUsed,
        outcome,
        ts: new Date().toISOString(),
        user: {
          userId: profile.userId,
          displayName: profile.displayName,
          pictureUrl: profile.pictureUrl
        },
        ua: navigator.userAgent,
        context: (() => {
          try { return liff.getContext ? liff.getContext() : null; } catch { return null; }
        })(),
        nonce: (Math.random().toString(36).slice(2) + Date.now().toString(36))
      };

      fetch(WEBHOOK, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).catch(err => console.warn("Webhook 回報失敗（略過）", err));

      // 3 秒後自動關閉 LIFF 視窗
      setTimeout(() => {
        try {
          if (typeof liff !== "undefined" && liff.isInClient()) {
            liff.closeWindow();
          } else {
            window.close();
          }
        } catch (_) {}
      }, 3000);
    }

    drawBtn.addEventListener('click', doDraw);
  </script>
</body>
</html>
